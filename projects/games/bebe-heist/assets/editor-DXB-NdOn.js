import{c as uo,d as ao,f as po,D as mo,g as ho,B as xo,K as bo,e as go,L as ko,R as b,C as k,T as s}from"./config-CXdi8Mls.js";function To(){return{rooms:[],corridors:[],doors:[],containers:[],tvs:[],babies:[],keys:[],tools:[],loots:[],walls:[],activeTool:"select",selection:null,camera:{x:0,y:0,zoom:1},dragState:null,babyWaypointMode:!1,cursorTx:0,cursorTy:0,hoverInfo:""}}function W(o){return structuredClone({rooms:o.rooms,corridors:o.corridors,doors:o.doors,containers:o.containers,tvs:o.tvs,babies:o.babies,keys:o.keys,tools:o.tools,loots:o.loots,walls:o.walls})}function Q(o,e){o.rooms=e.rooms,o.corridors=e.corridors,o.doors=e.doors,o.containers=e.containers,o.tvs=e.tvs,o.babies=e.babies,o.keys=e.keys,o.tools=e.tools,o.loots=e.loots,o.walls=e.walls}const wo=50,C=[],B=[];function y(o){C.push(W(o)),C.length>wo&&C.shift(),B.length=0}function oo(o){C.length!==0&&(B.push(W(o)),Q(o,C.pop()),o.selection=null)}function z(o){B.length!==0&&(C.push(W(o)),Q(o,B.pop()),o.selection=null)}function eo(o){o.rooms=uo.map(e=>({id:e.id,name:e.name,x:e.x,y:e.y,w:e.w,h:e.h,furn:(e.furn||[]).map(([r,n,i,t])=>({fx:r,fy:n,fw:i,fh:t}))})),o.corridors=ao.map(([e,r,n,i])=>({x:e,y:r,w:n,h:i})),o.tvs=po.map(e=>({tx:e.tx,ty:e.ty,room:e.room})),o.doors=mo.map(e=>({tx:e.tx,ty:e.ty,orientation:e.orientation,initial:e.initial,requiredKey:e.requiredKey})),o.containers=ho.map(e=>({tx:e.tx,ty:e.ty,room:e.room,fixed:e.fixed?{type:e.fixed.type,item:e.fixed.item}:void 0})),o.babies=xo.map(e=>({room:e.room,dx:e.dx,dy:e.dy,type:e.type,speed:e.speed,facing:e.facing,pauseTime:e.pauseTime,waypoints:e.waypoints.map(r=>({dx:r.dx,dy:r.dy})),roamRoom:e.roamRoom})),o.keys=bo.map(e=>({room:e.room,dx:e.dx,dy:e.dy,type:e.type})),o.tools=go.map(e=>({room:e.room,dx:e.dx,dy:e.dy,type:e.type})),o.loots=ko.map(e=>({room:e.room,dx:e.dx,dy:e.dy,type:e.type}))}function vo(o){const e=[];e.push("import type {"),e.push("  RoomDef, TVDef, DoorDef, ContainerDef,"),e.push("  BabyDef, KeyPickupDef, ToolPickupDef, LootDef,"),e.push("} from './types';"),e.push(""),e.push("export const ROOM_DEFS: RoomDef[] = [");for(const r of o.rooms){const n=r.furn.length>0?`, furn: [${r.furn.map(i=>`[${i.fx}, ${i.fy}, ${i.fw}, ${i.fh}]`).join(", ")}]`:"";e.push(`  { id: '${r.id}', name: '${r.name}', x: ${r.x}, y: ${r.y}, w: ${r.w}, h: ${r.h}${n} },`)}e.push("];"),e.push(""),e.push("export const CORRIDORS: number[][] = [");for(const r of o.corridors)e.push(`  [${r.x}, ${r.y}, ${r.w}, ${r.h}],`);e.push("];"),e.push(""),e.push("export const TV_DEFS: TVDef[] = [");for(const r of o.tvs)e.push(`  { tx: ${r.tx}, ty: ${r.ty}, room: '${r.room}' },`);e.push("];"),e.push(""),e.push("export const DOOR_DEFS: DoorDef[] = [");for(const r of o.doors){const n=r.requiredKey?`, requiredKey: '${r.requiredKey}'`:"";e.push(`  { tx: ${r.tx}, ty: ${r.ty}, orientation: '${r.orientation}', initial: '${r.initial}'${n} },`)}e.push("];"),e.push(""),e.push("export const CONTAINER_DEFS: ContainerDef[] = [");for(const r of o.containers){const n=r.fixed?`, fixed: { type: '${r.fixed.type}'${r.fixed.item?`, item: '${r.fixed.item}'`:""} }`:"";e.push(`  { tx: ${r.tx}, ty: ${r.ty}, room: '${r.room}'${n} },`)}e.push("];"),e.push(""),e.push("export const BABY_DEFS: BabyDef[] = [");for(const r of o.babies){const n=r.waypoints.map(t=>`{ dx: ${t.dx}, dy: ${t.dy} }`).join(", "),i=r.roamRoom?`, roamRoom: '${r.roamRoom}'`:"";e.push(`  { room: '${r.room}', dx: ${r.dx}, dy: ${r.dy}, type: '${r.type}', speed: ${r.speed}, facing: ${Mo(r.facing)}, pauseTime: ${r.pauseTime},`),e.push(`    waypoints: [${n}]${i} },`)}e.push("];"),e.push(""),e.push("export const KEY_PICKUP_DEFS: KeyPickupDef[] = [");for(const r of o.keys)e.push(`  { room: '${r.room}', dx: ${r.dx}, dy: ${r.dy}, type: '${r.type}' },`);e.push("];"),e.push(""),e.push("export const TOOL_PICKUP_DEFS: ToolPickupDef[] = [");for(const r of o.tools)e.push(`  { room: '${r.room}', dx: ${r.dx}, dy: ${r.dy}, type: '${r.type}' },`);e.push("];"),e.push(""),e.push("export const LOOT_DEFS: LootDef[] = [");for(const r of o.loots)e.push(`  { room: '${r.room}', dx: ${r.dx}, dy: ${r.dy}, type: '${r.type}' },`);if(e.push("];"),e.push(""),o.walls.length>0){e.push("export const WALL_OVERRIDES: { tx: number; ty: number }[] = [");for(const r of o.walls)e.push(`  { tx: ${r.tx}, ty: ${r.ty} },`);e.push("];"),e.push("")}return e.join(`
`)}function Mo(o){return o===Math.PI?"Math.PI":o===-Math.PI?"-Math.PI":o===Math.PI/2?"Math.PI / 2":o===-Math.PI/2?"-Math.PI / 2":String(o)}function So(o){const e=Array.from({length:b},()=>Array(k).fill(1)),r=(i,t,l,d)=>{for(let c=t;c<t+d&&c<b;c++)for(let u=i;u<i+l&&u<k;u++)c>=0&&u>=0&&(e[c][u]=0)};for(const i of o.rooms)r(i.x,i.y,i.w,i.h);for(const i of o.corridors)r(i.x,i.y,i.w,i.h);for(const i of o.rooms)for(const t of i.furn)for(let l=i.y+t.fy;l<i.y+t.fy+t.fh&&l<b;l++)for(let d=i.x+t.fx;d<i.x+t.fx+t.fw&&d<k;d++)l>=0&&d>=0&&(e[l][d]=2);for(const i of o.walls)i.ty>=0&&i.ty<b&&i.tx>=0&&i.tx<k&&(e[i.ty][i.tx]=1);const n=o.rooms.find(i=>i.id==="foyer");if(n){const i=n.x+Math.floor(n.w/2);for(let t=n.y+n.h;t<b;t++)e[t][i]=0}return e}function $o(o,e){const{camera:r}=e;o.save(),o.setTransform(r.zoom,0,0,r.zoom,-r.x*r.zoom,-r.y*r.zoom),o.fillStyle="#3a3a5c",o.fillRect(0,0,k*s,b*s);const n=So(e);Eo(o,n),Do(o),Co(o,e),Ro(o,e),Lo(o,e),Ko(o,e),Bo(o,e),Io(o,e),Oo(o,e),_o(o,e),Po(o,e),zo(o,e),o.restore()}function Eo(o,e){for(let r=0;r<b;r++)for(let n=0;n<k;n++){const i=n*s,t=r*s,l=e[r][n];l===1?(o.fillStyle="#3a3a5c",o.fillRect(i,t,s,s),o.fillStyle="#4e4e70",o.fillRect(i,t,s,1),o.fillRect(i,t,1,s),o.fillStyle="#28283e",o.fillRect(i,t+s-1,s,1),o.fillRect(i+s-1,t,1,s)):l===2?(o.fillStyle="#2a1f14",o.fillRect(i,t,s,s),o.fillStyle="#3d2e1c",o.fillRect(i+1,t+1,s-2,s-2),o.fillStyle="#4a3828",o.fillRect(i+2,t+2,s-4,s-4)):(o.fillStyle="#1e1e2e",o.fillRect(i,t,s,s))}}function Do(o){o.strokeStyle="rgba(255,255,255,0.04)",o.lineWidth=.5;for(let e=0;e<=k;e++)o.beginPath(),o.moveTo(e*s,0),o.lineTo(e*s,b*s),o.stroke();for(let e=0;e<=b;e++)o.beginPath(),o.moveTo(0,e*s),o.lineTo(k*s,e*s),o.stroke()}function Co(o,e){o.setLineDash([4,4]);for(let r=0;r<e.rooms.length;r++){const n=e.rooms[r],i=e.selection?.kind==="room"&&e.selection.index===r;o.strokeStyle=i?"#4a9eff":"rgba(74,222,128,0.3)",o.lineWidth=i?2:1,o.strokeRect(n.x*s,n.y*s,n.w*s,n.h*s),o.fillStyle="rgba(255,255,255,0.15)",o.font="9px monospace",o.textAlign="center",o.textBaseline="top",o.fillText(n.name||n.id,(n.x+n.w/2)*s,n.y*s-12)}o.setLineDash([])}function Ro(o,e){o.setLineDash([2,3]);for(let r=0;r<e.corridors.length;r++){const n=e.corridors[r],i=e.selection?.kind==="corridor"&&e.selection.index===r;o.strokeStyle=i?"#4a9eff":"rgba(251,191,36,0.25)",o.lineWidth=i?2:1,o.strokeRect(n.x*s,n.y*s,n.w*s,n.h*s)}o.setLineDash([])}function Lo(o,e){for(let r=0;r<e.doors.length;r++){const n=e.doors[r],i=n.tx*s,t=n.ty*s,l=e.selection?.kind==="door"&&e.selection.index===r;n.initial==="locked"?o.fillStyle=l?"#6366f1":"#4a4a6a":o.fillStyle=l?"#d97706":"#8B4513",o.fillRect(i+2,t+2,s-4,s-4),o.strokeStyle=l?"#4a9eff":"#654321",o.lineWidth=l?2:1,o.strokeRect(i+2,t+2,s-4,s-4),o.fillStyle="#fff",o.font="8px monospace",o.textAlign="center",o.textBaseline="middle";const d=n.initial==="locked"?n.requiredKey||"X":"D";o.fillText(d,i+s/2,t+s/2)}}function Ko(o,e){for(let r=0;r<e.containers.length;r++){const n=e.containers[r],i=n.tx*s,t=n.ty*s,l=e.selection?.kind==="container"&&e.selection.index===r;o.fillStyle=l?"#a78bfa":"#7c3aed",o.fillRect(i+4,t+4,s-8,s-8),o.fillStyle="#fff",o.font="7px monospace",o.textAlign="center",o.textBaseline="middle",o.fillText(n.fixed?"F":"C",i+s/2,t+s/2)}}function Bo(o,e){for(let r=0;r<e.tvs.length;r++){const n=e.tvs[r],i=n.tx*s,t=n.ty*s,l=e.selection?.kind==="tv"&&e.selection.index===r;o.fillStyle=l?"#60a5fa":"#3b82f6",o.fillRect(i+3,t+6,s-6,s-12),o.fillStyle="#bfdbfe",o.fillRect(i+5,t+8,s-10,s-16)}}function S(o,e,r,n){const i=o.rooms.find(t=>t.id===e);return i?{px:(i.x+i.w/2+r)*s,py:(i.y+i.h/2+n)*s}:{px:0,py:0}}function Io(o,e){for(let r=0;r<e.babies.length;r++){const n=e.babies[r],{px:i,py:t}=S(e,n.room,n.dx,n.dy),l=e.selection?.kind==="baby"&&e.selection.index===r;if(n.waypoints.length>0){o.strokeStyle=l?"rgba(74,158,255,0.5)":"rgba(255,255,255,0.15)",o.lineWidth=1,o.beginPath();const c=S(e,n.room,n.waypoints[0].dx,n.waypoints[0].dy);o.moveTo(c.px,c.py);for(let u=1;u<n.waypoints.length;u++){const p=S(e,n.room,n.waypoints[u].dx,n.waypoints[u].dy);o.lineTo(p.px,p.py)}o.lineTo(c.px,c.py),o.stroke();for(const u of n.waypoints){const p=S(e,n.room,u.dx,u.dy);o.fillStyle=l?"#4a9eff":"rgba(255,255,255,0.3)",o.beginPath(),o.arc(p.px,p.py,3,0,Math.PI*2),o.fill()}}const d={crawler:"#f59e0b",stawler:"#ec4899",boss:"#ef4444"};o.fillStyle=l?"#4a9eff":d[n.type]||"#f59e0b",o.beginPath(),o.arc(i,t,8,0,Math.PI*2),o.fill(),o.fillStyle="#fff",o.font="bold 7px monospace",o.textAlign="center",o.textBaseline="middle",o.fillText(n.type[0].toUpperCase(),i,t)}}function Oo(o,e){const r={keyA:"#ef4444",keyB:"#3b82f6",keyC:"#22c55e"};for(let n=0;n<e.keys.length;n++){const i=e.keys[n],{px:t,py:l}=S(e,i.room,i.dx,i.dy),d=e.selection?.kind==="key"&&e.selection.index===n;o.fillStyle=d?"#4a9eff":r[i.type]||"#facc15",o.fillRect(t-6,l-4,12,8),o.fillStyle="#fff",o.font="bold 7px monospace",o.textAlign="center",o.textBaseline="middle",o.fillText(i.type.replace("key",""),t,l)}}function _o(o,e){const r={ipad:"#a1a1aa",remote:"#71717a",pacifier:"#f59e0b"};for(let n=0;n<e.tools.length;n++){const i=e.tools[n],{px:t,py:l}=S(e,i.room,i.dx,i.dy),d=e.selection?.kind==="tool_pickup"&&e.selection.index===n;o.fillStyle=d?"#4a9eff":r[i.type]||"#9ca3af",o.beginPath(),o.moveTo(t,l-7),o.lineTo(t+7,l+4),o.lineTo(t-7,l+4),o.closePath(),o.fill(),o.fillStyle="#fff",o.font="6px monospace",o.textAlign="center",o.textBaseline="middle",o.fillText(i.type[0].toUpperCase(),t,l)}}function Po(o,e){for(let r=0;r<e.loots.length;r++){const n=e.loots[r],{px:i,py:t}=S(e,n.room,n.dx,n.dy),l=e.selection?.kind==="loot"&&e.selection.index===r;o.fillStyle=l?"#4a9eff":"#60a5fa",o.beginPath(),o.moveTo(i,t-8),o.lineTo(i+6,t),o.lineTo(i,t+8),o.lineTo(i-6,t),o.closePath(),o.fill(),o.fillStyle="#fff",o.font="6px monospace",o.textAlign="center",o.textBaseline="middle",o.fillText("$",i,t)}}function zo(o,e){if(!e.selection)return;const{kind:r,index:n}=e.selection;if(r==="room"&&e.rooms[n]){const i=e.rooms[n];o.strokeStyle="rgba(74,158,255,0.6)",o.lineWidth=3,o.strokeRect(i.x*s-1,i.y*s-1,i.w*s+2,i.h*s+2)}else if(r==="corridor"&&e.corridors[n]){const i=e.corridors[n];o.strokeStyle="rgba(74,158,255,0.6)",o.lineWidth=3,o.strokeRect(i.x*s-1,i.y*s-1,i.w*s+2,i.h*s+2)}}function Wo(o,e){const{camera:r,cursorTx:n,cursorTy:i}=e;o.save(),o.setTransform(r.zoom,0,0,r.zoom,-r.x*r.zoom,-r.y*r.zoom),o.strokeStyle="rgba(255,255,255,0.2)",o.lineWidth=1,o.strokeRect(n*s,i*s,s,s),o.restore()}function Ao(o,e){if(!e.dragState||e.dragState.type!=="create_rect")return;const r=e.dragState,n=Math.min(r.startTx,r.currentTx),i=Math.min(r.startTy,r.currentTy),t=Math.max(r.startTx,r.currentTx)+1,l=Math.max(r.startTy,r.currentTy)+1;o.save();const{camera:d}=e;o.setTransform(d.zoom,0,0,d.zoom,-d.x*d.zoom,-d.y*d.zoom),o.fillStyle="rgba(74,158,255,0.15)",o.fillRect(n*s,i*s,(t-n)*s,(l-i)*s),o.strokeStyle="#4a9eff",o.lineWidth=2,o.strokeRect(n*s,i*s,(t-n)*s,(l-i)*s),o.fillStyle="#4a9eff",o.font="10px monospace",o.textAlign="center",o.textBaseline="bottom",o.fillText(`${t-n}x${l-i}`,(n+t)/2*s,i*s-4),o.restore()}function No(o,e,r){for(let n=0;n<o.doors.length;n++)if(o.doors[n].tx===e&&o.doors[n].ty===r)return{kind:"door",index:n};for(let n=0;n<o.containers.length;n++)if(o.containers[n].tx===e&&o.containers[n].ty===r)return{kind:"container",index:n};for(let n=0;n<o.tvs.length;n++)if(o.tvs[n].tx===e&&o.tvs[n].ty===r)return{kind:"tv",index:n};for(let n=0;n<o.babies.length;n++){const i=o.babies[n],t=o.rooms.find(c=>c.id===i.room);if(!t)continue;const l=Math.round(t.x+t.w/2+i.dx),d=Math.round(t.y+t.h/2+i.dy);if(l===e&&d===r)return{kind:"baby",index:n}}for(let n=0;n<o.keys.length;n++){const i=o.keys[n],t=o.rooms.find(l=>l.id===i.room);if(t&&Math.round(t.x+t.w/2+i.dx)===e&&Math.round(t.y+t.h/2+i.dy)===r)return{kind:"key",index:n}}for(let n=0;n<o.tools.length;n++){const i=o.tools[n],t=o.rooms.find(l=>l.id===i.room);if(t&&Math.round(t.x+t.w/2+i.dx)===e&&Math.round(t.y+t.h/2+i.dy)===r)return{kind:"tool_pickup",index:n}}for(let n=0;n<o.loots.length;n++){const i=o.loots[n],t=o.rooms.find(l=>l.id===i.room);if(t&&Math.round(t.x+t.w/2+i.dx)===e&&Math.round(t.y+t.h/2+i.dy)===r)return{kind:"loot",index:n}}for(let n=0;n<o.rooms.length;n++){const i=o.rooms[n];if(e>=i.x&&e<i.x+i.w&&r>=i.y&&r<i.y+i.h){for(let t=0;t<i.furn.length;t++){const l=i.furn[t];if(e>=i.x+l.fx&&e<i.x+l.fx+l.fw&&r>=i.y+l.fy&&r<i.y+l.fy+l.fh)return{kind:"furniture",index:n,furnIndex:t}}return{kind:"room",index:n}}}for(let n=0;n<o.corridors.length;n++){const i=o.corridors[n];if(e>=i.x&&e<i.x+i.w&&r>=i.y&&r<i.y+i.h)return{kind:"corridor",index:n}}return null}function Y(o,e,r,n,i,t){const l=e===n,d=e===n+t-1,c=o===r,u=o===r+i-1;return l&&!u&&!c?"n":d&&!u&&!c?"s":c?"w":u?"e":null}let $=!1;const Fo={onMouseDown(o,e,r,n){if(n!==0)return;$=!1;const i=No(o,e,r);if(i&&o.selection&&i.kind===o.selection.kind&&i.index===o.selection.index){if(i.kind==="room"){const t=o.rooms[i.index],l=Y(e,r,t.x,t.y,t.w,t.h);if(l){o.dragState={type:"resize",entityKind:"room",index:i.index,edge:l,startVal:l==="n"?t.y:l==="s"?t.y+t.h:l==="w"?t.x:t.x+t.w};return}}else if(i.kind==="corridor"){const t=o.corridors[i.index],l=Y(e,r,t.x,t.y,t.w,t.h);if(l){o.dragState={type:"resize",entityKind:"corridor",index:i.index,edge:l,startVal:l==="n"?t.y:l==="s"?t.y+t.h:l==="w"?t.x:t.x+t.w};return}}}o.selection=i,i&&(o.dragState={type:"move",entityKind:i.kind,index:i.index,offsetTx:e,offsetTy:r})},onMouseMove(o,e,r){if(o.dragState?.type==="resize"){const n=o.dragState;if($||(y(o),$=!0),n.entityKind==="room"&&o.rooms[n.index]){const i=o.rooms[n.index];U(i,n.edge,e,r)}else if(n.entityKind==="corridor"&&o.corridors[n.index]){const i=o.corridors[n.index];U(i,n.edge,e,r)}return}if(o.dragState?.type==="move"){const n=o.dragState,i=e-n.offsetTx,t=r-n.offsetTy;if(i===0&&t===0)return;if($||(y(o),$=!0),n.entityKind==="room"&&o.rooms[n.index])o.rooms[n.index].x+=i,o.rooms[n.index].y+=t;else if(n.entityKind==="corridor"&&o.corridors[n.index])o.corridors[n.index].x+=i,o.corridors[n.index].y+=t;else if(n.entityKind==="door"&&o.doors[n.index])o.doors[n.index].tx+=i,o.doors[n.index].ty+=t;else if(n.entityKind==="container"&&o.containers[n.index])o.containers[n.index].tx+=i,o.containers[n.index].ty+=t;else if(n.entityKind==="tv"&&o.tvs[n.index])o.tvs[n.index].tx+=i,o.tvs[n.index].ty+=t;else if(n.entityKind==="baby"&&o.babies[n.index])o.babies[n.index].dx+=i,o.babies[n.index].dy+=t;else if(n.entityKind==="key"&&o.keys[n.index])o.keys[n.index].dx+=i,o.keys[n.index].dy+=t;else if(n.entityKind==="tool_pickup"&&o.tools[n.index])o.tools[n.index].dx+=i,o.tools[n.index].dy+=t;else if(n.entityKind==="loot"&&o.loots[n.index])o.loots[n.index].dx+=i,o.loots[n.index].dy+=t;else if(n.entityKind==="furniture"){const l=o.rooms[n.index];if(l&&l.furn[o.selection?.furnIndex??-1]){const d=l.furn[o.selection.furnIndex];d.fx+=i,d.fy+=t}}n.offsetTx=e,n.offsetTy=r}},onMouseUp(o){o.dragState=null,$=!1},onKeyDown(o,e){if(e==="Delete"||e==="Backspace"){if(!o.selection)return;y(o);const{kind:r,index:n,furnIndex:i}=o.selection;r==="room"?o.rooms.splice(n,1):r==="corridor"?o.corridors.splice(n,1):r==="furniture"&&o.rooms[n]?o.rooms[n].furn.splice(i,1):r==="door"?o.doors.splice(n,1):r==="container"?o.containers.splice(n,1):r==="tv"?o.tvs.splice(n,1):r==="baby"?o.babies.splice(n,1):r==="key"?o.keys.splice(n,1):r==="tool_pickup"?o.tools.splice(n,1):r==="loot"&&o.loots.splice(n,1),o.selection=null}},renderOverlay(o,e,r){if(!e.selection)return;const{kind:n,index:i}=e.selection;let t=0,l=0,d=0,c=0;if(n==="room"&&e.rooms[i]){const x=e.rooms[i];t=x.x,l=x.y,d=x.w,c=x.h}else if(n==="corridor"&&e.corridors[i]){const x=e.corridors[i];t=x.x,l=x.y,d=x.w,c=x.h}else return;o.fillStyle="#4a9eff";const u=6,p=(t+d/2)*r,w=(l+c/2)*r;o.fillRect(p-u/2,l*r-u/2,u,u),o.fillRect(p-u/2,(l+c)*r-u/2,u,u),o.fillRect(t*r-u/2,w-u/2,u,u),o.fillRect((t+d)*r-u/2,w-u/2,u,u)}};function U(o,e,r,n){switch(e){case"n":{const i=n,t=o.y+o.h;i<t&&(o.y=i,o.h=t-i);break}case"s":{const i=n-o.y+1;i>=1&&(o.h=i);break}case"w":{const i=r,t=o.x+o.w;i<t&&(o.x=i,o.w=t-i);break}case"e":{const i=r-o.x+1;i>=1&&(o.w=i);break}}}let X=0;const Yo={onMouseDown(o,e,r,n){n===0&&(o.dragState={type:"create_rect",startTx:e,startTy:r,currentTx:e,currentTy:r})},onMouseMove(o,e,r){o.dragState?.type==="create_rect"&&(o.dragState.currentTx=e,o.dragState.currentTy=r)},onMouseUp(o){if(o.dragState?.type!=="create_rect")return;const e=o.dragState,r=Math.min(e.startTx,e.currentTx),n=Math.min(e.startTy,e.currentTy),i=Math.abs(e.currentTx-e.startTx)+1,t=Math.abs(e.currentTy-e.startTy)+1;if(i>=2&&t>=2){y(o),X++;const l=`room_${X}`;o.rooms.push({id:l,name:l.toUpperCase(),x:r,y:n,w:i,h:t,furn:[]}),o.selection={kind:"room",index:o.rooms.length-1}}o.dragState=null},renderOverlay(){}},Uo={onMouseDown(o,e,r,n){n===0&&(o.dragState={type:"create_rect",startTx:e,startTy:r,currentTx:e,currentTy:r})},onMouseMove(o,e,r){o.dragState?.type==="create_rect"&&(o.dragState.currentTx=e,o.dragState.currentTy=r)},onMouseUp(o){if(o.dragState?.type!=="create_rect")return;const e=o.dragState,r=Math.min(e.startTx,e.currentTx),n=Math.min(e.startTy,e.currentTy),i=Math.abs(e.currentTx-e.startTx)+1,t=Math.abs(e.currentTy-e.startTy)+1;i>=1&&t>=1&&(y(o),o.corridors.push({x:r,y:n,w:i,h:t}),o.selection={kind:"corridor",index:o.corridors.length-1}),o.dragState=null},renderOverlay(){}};function H(o,e,r){for(let n=0;n<o.rooms.length;n++){const i=o.rooms[n];if(e>=i.x&&e<i.x+i.w&&r>=i.y&&r<i.y+i.h)return n}return-1}const Xo={onMouseDown(o,e,r,n){n===0&&H(o,e,r)!==-1&&(o.dragState={type:"create_rect",startTx:e,startTy:r,currentTx:e,currentTy:r})},onMouseMove(o,e,r){o.dragState?.type==="create_rect"&&(o.dragState.currentTx=e,o.dragState.currentTy=r)},onMouseUp(o){if(o.dragState?.type!=="create_rect")return;const e=o.dragState,r=Math.min(e.startTx,e.currentTx),n=Math.min(e.startTy,e.currentTy),i=Math.abs(e.currentTx-e.startTx)+1,t=Math.abs(e.currentTy-e.startTy)+1,l=H(o,r,n);if(l!==-1){const d=o.rooms[l];y(o),d.furn.push({fx:r-d.x,fy:n-d.y,fw:i,fh:t}),o.selection={kind:"furniture",index:l,furnIndex:d.furn.length-1}}o.dragState=null},renderOverlay(){}};function Ho(o,e,r){for(const n of o.rooms)if(e>=n.x&&e<n.x+n.w&&r>=n.y&&r<n.y+n.h)return n.id;return""}function P(o,e,r,n){const i=o.rooms.find(t=>t.id===e);return i?{dx:r-(i.x+i.w/2),dy:n-(i.y+i.h/2)}:{dx:0,dy:0}}function E(o){return{onMouseDown(e,r,n,i){if(i!==0)return;y(e);const t=Ho(e,r,n);switch(o){case"door":e.doors.push({tx:r,ty:n,orientation:"v",initial:"closed"}),e.selection={kind:"door",index:e.doors.length-1};break;case"container":e.containers.push({tx:r,ty:n,room:t||"unknown"}),e.selection={kind:"container",index:e.containers.length-1};break;case"tv":e.tvs.push({tx:r,ty:n,room:t||"unknown"}),e.selection={kind:"tv",index:e.tvs.length-1};break;case"key":{const l=P(e,t,r,n);e.keys.push({room:t||"unknown",dx:l.dx,dy:l.dy,type:"keyA"}),e.selection={kind:"key",index:e.keys.length-1};break}case"tool_pickup":{const l=P(e,t,r,n);e.tools.push({room:t||"unknown",dx:l.dx,dy:l.dy,type:"ipad"}),e.selection={kind:"tool_pickup",index:e.tools.length-1};break}case"loot":{const l=P(e,t,r,n);e.loots.push({room:t||"unknown",dx:l.dx,dy:l.dy,type:"diamond"}),e.selection={kind:"loot",index:e.loots.length-1};break}}},onMouseMove(){},onMouseUp(){},renderOverlay(){}}}function qo(o,e,r){for(const n of o.rooms)if(e>=n.x&&e<n.x+n.w&&r>=n.y&&r<n.y+n.h)return n.id;return""}function q(o,e,r,n){const i=o.rooms.find(t=>t.id===e);return i?{dx:r-(i.x+i.w/2),dy:n-(i.y+i.h/2)}:{dx:0,dy:0}}const Vo={onMouseDown(o,e,r,n){if(n!==0)return;if(o.babyWaypointMode&&o.selection?.kind==="baby"){const l=o.babies[o.selection.index];if(l){y(o);const d=q(o,l.room,e,r);l.waypoints.push({dx:d.dx,dy:d.dy})}return}const i=qo(o,e,r);if(!i)return;y(o);const t=q(o,i,e,r);o.babies.push({room:i,dx:t.dx,dy:t.dy,type:"crawler",speed:45,facing:0,pauseTime:2,waypoints:[]}),o.selection={kind:"baby",index:o.babies.length-1},o.babyWaypointMode=!0},onMouseMove(){},onMouseUp(){},onKeyDown(o,e){(e==="Enter"||e==="Escape")&&(o.babyWaypointMode=!1)},renderOverlay(o,e,r){if(!e.babyWaypointMode||e.selection?.kind!=="baby")return;const n=e.babies[e.selection.index];if(!n)return;const i=e.rooms.find(p=>p.id===n.room);if(!i)return;const t=n.waypoints.length>0?n.waypoints[n.waypoints.length-1]:{dx:n.dx,dy:n.dy},l=(i.x+i.w/2+t.dx)*r,d=(i.y+i.h/2+t.dy)*r,c=e.cursorTx*r+r/2,u=e.cursorTy*r+r/2;o.strokeStyle="rgba(74,158,255,0.4)",o.lineWidth=1,o.setLineDash([4,4]),o.beginPath(),o.moveTo(l,d),o.lineTo(c,u),o.stroke(),o.setLineDash([])}};let L=!1,K=!1,D=!1;function jo(o,e,r){return o.walls.some(n=>n.tx===e&&n.ty===r)}function V(o,e,r){jo(o,e,r)||o.walls.push({tx:e,ty:r})}function j(o,e,r){o.walls=o.walls.filter(n=>!(n.tx===e&&n.ty===r))}const Go={onMouseDown(o,e,r,n){D=!1,n===0?(L=!0,K=!1,D||(y(o),D=!0),V(o,e,r)):n===2&&(K=!0,L=!1,D||(y(o),D=!0),j(o,e,r))},onMouseMove(o,e,r){L&&V(o,e,r),K&&j(o,e,r)},onMouseUp(){L=!1,K=!1,D=!1},renderOverlay(){}},Zo={select:Fo,room:Yo,corridor:Uo,furniture:Xo,door:E("door"),container:E("container"),tv:E("tv"),baby:Vo,key:E("key"),tool_pickup:E("tool_pickup"),loot:E("loot"),wall:Go};function R(o){return Zo[o.activeTool]}const no=[{label:"Layout",tools:[{mode:"select",label:"Select",color:"#9ca3af",key:"S"},{mode:"room",label:"Room",color:"#4ade80",key:"R"},{mode:"corridor",label:"Corridor",color:"#fbbf24",key:"C"},{mode:"furniture",label:"Furniture",color:"#8B6914",key:"F"},{mode:"wall",label:"Wall",color:"#3a3a5c",key:"W"}]},{label:"Entities",tools:[{mode:"door",label:"Door",color:"#8B4513",key:"D"},{mode:"container",label:"Container",color:"#7c3aed",key:"N"},{mode:"tv",label:"TV",color:"#3b82f6",key:"T"}]},{label:"NPCs",tools:[{mode:"baby",label:"Baby",color:"#f59e0b",key:"B"}]},{label:"Pickups",tools:[{mode:"key",label:"Key",color:"#ef4444",key:"K"},{mode:"tool_pickup",label:"Tool",color:"#a1a1aa",key:"P"},{mode:"loot",label:"Loot",color:"#60a5fa",key:"L"}]}],ro={};for(const o of no)for(const e of o.tools)ro[e.key.toLowerCase()]=e.mode;function Jo(o){return ro[o.toLowerCase()]??null}function Qo(o,e,r){o.innerHTML="";for(const n of no){const i=document.createElement("div");i.className="tool-group";const t=document.createElement("div");t.className="tool-group-label",t.textContent=n.label,i.appendChild(t);for(const l of n.tools){const d=document.createElement("button");d.className="tool-btn",e.activeTool===l.mode&&d.classList.add("active"),d.dataset.mode=l.mode;const c=document.createElement("span");c.className="tool-icon",c.style.background=l.color,d.appendChild(c);const u=document.createElement("span");u.textContent=`${l.label} (${l.key})`,d.appendChild(u),d.addEventListener("click",()=>{e.activeTool=l.mode,e.babyWaypointMode=!1,r()}),i.appendChild(d)}o.appendChild(i)}}function oe(o,e){for(const r of o.querySelectorAll(".tool-btn")){const n=r;n.classList.toggle("active",n.dataset.mode===e.activeTool)}}function io(o,e){if(o.innerHTML="",!e.selection){o.innerHTML=`
      <span style="color:#4b5563">Nothing selected</span>
      <div style="margin-top:12px;color:#4b5563;font-size:10px">
        Rooms: ${e.rooms.length}<br>
        Corridors: ${e.corridors.length}<br>
        Doors: ${e.doors.length}<br>
        Containers: ${e.containers.length}<br>
        TVs: ${e.tvs.length}<br>
        Babies: ${e.babies.length}<br>
        Keys: ${e.keys.length}<br>
        Tools: ${e.tools.length}<br>
        Loots: ${e.loots.length}
      </div>`;return}const{kind:r,index:n,furnIndex:i}=e.selection;if(r==="room"&&e.rooms[n]){const l=e.rooms[n];g(o,"ROOM",l.name),Z(o,"id",l.id,d=>{y(e),l.id=d}),Z(o,"name",l.name,d=>{y(e),l.name=d}),a(o,"x",l.x,d=>{y(e),l.x=d}),a(o,"y",l.y,d=>{y(e),l.y=d}),a(o,"w",l.w,d=>{y(e),l.w=Math.max(1,d)}),a(o,"h",l.h,d=>{y(e),l.h=Math.max(1,d)}),G(o,`Furniture: ${l.furn.length}`)}else if(r==="corridor"&&e.corridors[n]){const l=e.corridors[n];g(o,"CORRIDOR",`${l.w}x${l.h}`),a(o,"x",l.x,d=>{y(e),l.x=d}),a(o,"y",l.y,d=>{y(e),l.y=d}),a(o,"w",l.w,d=>{y(e),l.w=Math.max(1,d)}),a(o,"h",l.h,d=>{y(e),l.h=Math.max(1,d)})}else if(r==="furniture"&&e.rooms[n]){const l=e.rooms[n],d=l.furn[i];if(!d)return;g(o,"FURNITURE",`in ${l.name}`),a(o,"fx",d.fx,c=>{y(e),d.fx=c}),a(o,"fy",d.fy,c=>{y(e),d.fy=c}),a(o,"fw",d.fw,c=>{y(e),d.fw=Math.max(1,c)}),a(o,"fh",d.fh,c=>{y(e),d.fh=Math.max(1,c)})}else if(r==="door"&&e.doors[n]){const l=e.doors[n];g(o,"DOOR",`${l.tx},${l.ty}`),a(o,"tx",l.tx,d=>{y(e),l.tx=d}),a(o,"ty",l.ty,d=>{y(e),l.ty=d}),m(o,"orient",l.orientation,["h","v"],d=>{y(e),l.orientation=d}),m(o,"state",l.initial,["open","closed","locked"],d=>{y(e),l.initial=d}),m(o,"key",l.requiredKey||"none",["none","keyA","keyB","keyC"],d=>{y(e),l.requiredKey=d==="none"?void 0:d})}else if(r==="container"&&e.containers[n]){const l=e.containers[n];g(o,"CONTAINER",l.room),a(o,"tx",l.tx,c=>{y(e),l.tx=c}),a(o,"ty",l.ty,c=>{y(e),l.ty=c}),m(o,"room",l.room,e.rooms.map(c=>c.id),c=>{y(e),l.room=c});const d=!!l.fixed;m(o,"fixed",d?l.fixed.type:"random",["random","cheese","throwable","gear","key"],c=>{y(e),c==="random"?l.fixed=void 0:l.fixed={type:c}})}else if(r==="tv"&&e.tvs[n]){const l=e.tvs[n];g(o,"TV",l.room),a(o,"tx",l.tx,d=>{y(e),l.tx=d}),a(o,"ty",l.ty,d=>{y(e),l.ty=d}),m(o,"room",l.room,e.rooms.map(d=>d.id),d=>{y(e),l.room=d})}else if(r==="baby"&&e.babies[n]){const l=e.babies[n];g(o,"BABY",`${l.type} in ${l.room}`),m(o,"type",l.type,["crawler","stawler","boss"],c=>{y(e),l.type=c}),m(o,"room",l.room,e.rooms.map(c=>c.id),c=>{y(e),l.room=c}),a(o,"dx",l.dx,c=>{y(e),l.dx=c}),a(o,"dy",l.dy,c=>{y(e),l.dy=c}),a(o,"speed",l.speed,c=>{y(e),l.speed=c}),a(o,"pause",l.pauseTime,c=>{y(e),l.pauseTime=c}),G(o,`Waypoints: ${l.waypoints.length}`);for(let c=0;c<l.waypoints.length;c++){const u=l.waypoints[c],p=document.createElement("div");p.style.cssText="display:flex;align-items:center;gap:4px;margin-bottom:2px;padding-left:4px",p.innerHTML=`<span style="color:#6b7280;font-size:9px;width:24px">#${c}</span>
        <span style="color:#9ca3af;font-size:10px">${u.dx}, ${u.dy}</span>`;const w=document.createElement("button");w.textContent="x",w.style.cssText="background:#7f1d1d;color:#fca5a5;border:none;padding:0 4px;cursor:pointer;font-size:9px;margin-left:auto;border-radius:2px",w.addEventListener("click",()=>{y(e),l.waypoints.splice(c,1)}),p.appendChild(w),o.appendChild(p)}const d=document.createElement("button");d.textContent=e.babyWaypointMode?"Stop Adding Waypoints":"Add Waypoints",d.style.cssText="width:100%;margin-top:4px;padding:3px;background:#1e3a5f;color:#93c5fd;border:1px solid #2563eb;cursor:pointer;font-family:inherit;font-size:10px;border-radius:2px",d.addEventListener("click",()=>{e.babyWaypointMode=!e.babyWaypointMode}),o.appendChild(d)}else if(r==="key"&&e.keys[n]){const l=e.keys[n];g(o,"KEY",l.type),m(o,"type",l.type,["keyA","keyB","keyC"],d=>{y(e),l.type=d}),m(o,"room",l.room,e.rooms.map(d=>d.id),d=>{y(e),l.room=d}),a(o,"dx",l.dx,d=>{y(e),l.dx=d}),a(o,"dy",l.dy,d=>{y(e),l.dy=d})}else if(r==="tool_pickup"&&e.tools[n]){const l=e.tools[n];g(o,"TOOL",l.type),m(o,"type",l.type,["ipad","remote","pacifier"],d=>{y(e),l.type=d}),m(o,"room",l.room,e.rooms.map(d=>d.id),d=>{y(e),l.room=d}),a(o,"dx",l.dx,d=>{y(e),l.dx=d}),a(o,"dy",l.dy,d=>{y(e),l.dy=d})}else if(r==="loot"&&e.loots[n]){const l=e.loots[n];g(o,"LOOT",l.type),m(o,"type",l.type,["cash","gold","diamond","key","docs","jewels","coin"],d=>{y(e),l.type=d}),m(o,"room",l.room,e.rooms.map(d=>d.id),d=>{y(e),l.room=d}),a(o,"dx",l.dx,d=>{y(e),l.dx=d}),a(o,"dy",l.dy,d=>{y(e),l.dy=d})}const t=document.createElement("button");t.className="btn-delete",t.textContent="Delete",t.addEventListener("click",()=>{y(e),r==="room"?e.rooms.splice(n,1):r==="corridor"?e.corridors.splice(n,1):r==="furniture"&&e.rooms[n]?e.rooms[n].furn.splice(i,1):r==="door"?e.doors.splice(n,1):r==="container"?e.containers.splice(n,1):r==="tv"?e.tvs.splice(n,1):r==="baby"?e.babies.splice(n,1):r==="key"?e.keys.splice(n,1):r==="tool_pickup"?e.tools.splice(n,1):r==="loot"&&e.loots.splice(n,1),e.selection=null}),o.appendChild(t)}function g(o,e,r){const n=document.createElement("div");n.style.cssText="margin-bottom:8px;font-weight:bold;color:#d1d5db",n.textContent=`${e}: ${r}`,o.appendChild(n)}function G(o,e){const r=document.createElement("div");r.style.cssText="color:#6b7280;font-size:10px;margin:4px 0",r.textContent=e,o.appendChild(r)}function Z(o,e,r,n){const i=document.createElement("div");i.className="prop-row",i.innerHTML=`<span class="prop-label">${e}</span>`;const t=document.createElement("input");t.className="prop-input",t.value=r,t.addEventListener("change",()=>n(t.value)),i.appendChild(t),o.appendChild(i)}function a(o,e,r,n){const i=document.createElement("div");i.className="prop-row",i.innerHTML=`<span class="prop-label">${e}</span>`;const t=document.createElement("input");t.className="prop-input",t.type="number",t.value=String(r),t.step="1",t.addEventListener("change",()=>n(Number(t.value))),i.appendChild(t),o.appendChild(i)}function m(o,e,r,n,i){const t=document.createElement("div");t.className="prop-row",t.innerHTML=`<span class="prop-label">${e}</span>`;const l=document.createElement("select");l.className="prop-select";for(const d of n){const c=document.createElement("option");c.value=d,c.textContent=d,d===r&&(c.selected=!0),l.appendChild(c)}l.addEventListener("change",()=>i(l.value)),t.appendChild(l),o.appendChild(t)}const f=To();eo(f);const lo=document.getElementById("canvas-wrap"),h=document.getElementById("editor-canvas"),M=h.getContext("2d");function to(){const o=lo.getBoundingClientRect();h.width=o.width,h.height=o.height}to();window.addEventListener("resize",to);const I=lo.getBoundingClientRect(),A=Math.min(I.width/(k*s),I.height/(b*s))*.95;f.camera.zoom=A;f.camera.x=(k*s-I.width/A)/2;f.camera.y=(b*s-I.height/A)/2;const so=document.getElementById("toolbar"),co=document.getElementById("props-content");function T(){oe(so,f),io(co,f),N()}Qo(so,f,T);const ee=document.getElementById("status-pos"),ne=document.getElementById("status-zoom"),re=document.getElementById("status-tool");function N(){ee.textContent=`${f.cursorTx}, ${f.cursorTy}`,ne.textContent=`${Math.round(f.camera.zoom*100)}%`,re.textContent=f.activeTool}function ie(o,e,r){if(o.activeTool!=="select"||!o.selection)return"default";const{kind:n,index:i}=o.selection;let t=0,l=0,d=0,c=0;if(n==="room"&&o.rooms[i]){const v=o.rooms[i];t=v.x,l=v.y,d=v.w,c=v.h}else if(n==="corridor"&&o.corridors[i]){const v=o.corridors[i];t=v.x,l=v.y,d=v.w,c=v.h}else return"default";const u=e>=t&&e<t+d,p=r>=l&&r<l+c;if(!u&&!p)return"default";const w=r===l&&u,x=r===l+c-1&&u,O=e===t&&p,_=e===t+d-1&&p;return w&&!_&&!O||x&&!_&&!O?"ns-resize":O||_?"ew-resize":"default"}function fo(o,e){const r=h.getBoundingClientRect(),n=(o-r.left)/f.camera.zoom+f.camera.x,i=(e-r.top)/f.camera.zoom+f.camera.y;return{wx:n,wy:i}}function F(o,e){const{wx:r,wy:n}=fo(o,e);return{tx:Math.floor(r/s),ty:Math.floor(n/s)}}let J="";function le(){return f.selection?`${f.selection.kind}:${f.selection.index}:${f.selection.furnIndex??""}`:""}h.addEventListener("mousedown",o=>{if(o.preventDefault(),o.button===1||o.button===0&&(o.ctrlKey||o.metaKey)){f.dragState={type:"pan",startCamX:f.camera.x,startCamY:f.camera.y,startMouseX:o.clientX,startMouseY:o.clientY};return}const{tx:e,ty:r}=F(o.clientX,o.clientY);R(f).onMouseDown(f,e,r,o.button,o),T()});h.addEventListener("mousemove",o=>{const{tx:e,ty:r}=F(o.clientX,o.clientY);if(f.cursorTx=e,f.cursorTy=r,f.dragState?.type==="pan"){const i=f.dragState;f.camera.x=i.startCamX-(o.clientX-i.startMouseX)/f.camera.zoom,f.camera.y=i.startCamY-(o.clientY-i.startMouseY)/f.camera.zoom,h.style.cursor="grabbing";return}h.style.cursor=ie(f,e,r),R(f).onMouseMove(f,e,r,o),N()});h.addEventListener("mouseup",o=>{if(f.dragState?.type==="pan"){f.dragState=null;return}const{tx:e,ty:r}=F(o.clientX,o.clientY);R(f).onMouseUp(f,e,r),f.dragState=null,T()});h.addEventListener("wheel",o=>{o.preventDefault();const{wx:e,wy:r}=fo(o.clientX,o.clientY),n=o.deltaY<0?1.15:.87,i=Math.max(.15,Math.min(6,f.camera.zoom*n));f.camera.x=e-(e-f.camera.x)*(f.camera.zoom/i),f.camera.y=r-(r-f.camera.y)*(f.camera.zoom/i),f.camera.zoom=i,N()},{passive:!1});window.addEventListener("keydown",o=>{if(o.target instanceof HTMLInputElement||o.target instanceof HTMLSelectElement||o.target instanceof HTMLTextAreaElement)return;if((o.ctrlKey||o.metaKey)&&o.key==="z"){o.preventDefault(),o.shiftKey?z(f):oo(f),T();return}if((o.ctrlKey||o.metaKey)&&o.key==="y"){o.preventDefault(),z(f),T();return}const e=Jo(o.key);if(e){f.activeTool=e,f.babyWaypointMode=!1,T();return}const r=R(f);r.onKeyDown&&(r.onKeyDown(f,o.key),T())});h.addEventListener("contextmenu",o=>o.preventDefault());document.getElementById("btn-import").addEventListener("click",()=>{eo(f),f.selection=null,T()});document.getElementById("btn-export").addEventListener("click",()=>{const o=vo(f),e=document.getElementById("export-textarea");e.value=o,document.getElementById("export-modal").classList.add("visible")});document.getElementById("btn-copy").addEventListener("click",()=>{const o=document.getElementById("export-textarea");navigator.clipboard.writeText(o.value)});document.getElementById("btn-close-export").addEventListener("click",()=>{document.getElementById("export-modal").classList.remove("visible")});document.getElementById("btn-undo").addEventListener("click",()=>{oo(f),T()});document.getElementById("btn-redo").addEventListener("click",()=>{z(f),T()});function yo(){M.clearRect(0,0,h.width,h.height),$o(M,f),Wo(M,f),Ao(M,f);const o=R(f);M.save(),M.setTransform(f.camera.zoom,0,0,f.camera.zoom,-f.camera.x*f.camera.zoom,-f.camera.y*f.camera.zoom),o.renderOverlay(M,f,s),M.restore();const e=le();e!==J&&(J=e,io(co,f)),requestAnimationFrame(yo)}requestAnimationFrame(yo);
